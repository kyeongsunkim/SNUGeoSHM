from groundhog.siteinvestigation.insitutests.pcpt_processing import PCPTProcessing
from groundhog.general.soilprofile import SoilProfile
from groundhog.siteinvestigation.insitutests.pcpt_processing import DEFAULT_CONE_PROPERTIES
from groundhog.siteinvestigation.insitutests.pcpt_processing import CORRELATIONS
from groundhog.general.plotting import LogPlot
import numpy as np
import pandas as pd 
from groundhog.general import soilprofile as sp
from groundhog.general.soilprofile import read_excel
from groundhog.general.plotting import LogPlotMatplotlib
# https://offshorewind.rvo.nl/page/view/398f49f5-5dad-4ae1-b97b-14703e7b73b7/studies-borssele-i-ii
# https://hub.2i2c.mybinder.org/user/snakesonabrain-groundhog-2d210khv/lab/tree/notebooks/Tutorial%20-%20Groundhog%20parameter%20selection%20example.ipynb

# A dataframe is be created from Excel data and added as the .data attribute of the PCPTProcessing object.
pcpt = PCPTProcessing(title="Example PCPT Excel")

# load Excel data
pcpt.load_excel(path="Data/excel_example_cpt.xlsx",
    u2_key="u [kPa]", u2_multiplier=0.001) # convert kPa to MPa
pcpt.data.head() #pcpt.data.tail()

# Set cone properties
print(DEFAULT_CONE_PROPERTIES)
layering = SoilProfile({
    "Depth from [m]": [0, 3.16, 5.9, 14.86, 15.7],
    "Depth to [m]": [3.16, 5.9, 14.86, 15.7, 20],
    "Total unit weight [kN/m3]": [18, 17, 19.5, 20, 20],
    'Soil type': ['SAND', 'CLAY', 'SAND', 'SAND', 'SAND']
})
layering.to_excel("Data/excel_example_layering.xlsx")

profile_1 = sp.read_excel("Data/excel_example_layering.xlsx")
                          
profile_1
profile_1.calculate_overburden()


pcpt.map_properties(layer_profile=profile_1, cone_profile=DEFAULT_CONE_PROPERTIES)
pcpt.plot_raw_pcpt()
pcpt.normalise_pcpt() # Normalize
pcpt.plot_normalised_pcpt()
pcpt.plot_robertson_chart()

#  Here, we will apply the correlation of Mayne & Rix to clay and Rix & Stokoe to sand.
# Correlations
list(CORRELATIONS.keys())
pcpt.apply_correlation('Ic Robertson and Wride (1998)', outputs={'Ic [-]':'Ic [-]'})
pcpt.apply_correlation(
    'Gmax Rix and Stokoe (1991)', outputs={'Gmax [kPa]': 'Gmax sand [kPa]'},
    apply_for_soiltypes=['SAND',])
pcpt.apply_correlation(
    'Gmax Mayne and Rix (1993)', outputs={'Gmax [kPa]': 'Gmax clay [kPa]'},
    apply_for_soiltypes=['CLAY',])

# The calculated properties can be visualized with a LogPlot. The keys to be plotted in each panel need to be provided in the add_trace method. 
# In the example below, the first panel only contain qc, second Ic, third Gmax for sand and clay.
cpt_processed_plot = LogPlot(profile_1, no_panels=3, fillcolordict={'SAND': 'yellow', 'CLAY': 'brown'})
cpt_processed_plot.add_trace(
    x=pcpt.data['qc [MPa]'],
    z=pcpt.data['z [m]'],
    name='qc',
    showlegend=False,
    panel_no=1)
cpt_processed_plot.add_trace(
    x=pcpt.data['Ic [-]'],
    z=pcpt.data['z [m]'],
    name='Ic',
    showlegend=False,
    panel_no=2)
cpt_processed_plot.add_trace(
    x=pcpt.data['Gmax sand [kPa]'],
    z=pcpt.data['z [m]'],
    name='Gmax SAND',
    showlegend=True,
    panel_no=3)
cpt_processed_plot.add_trace(
    x=pcpt.data['Gmax clay [kPa]'],
    z=pcpt.data['z [m]'],
    name='Gmax CLAY',
    showlegend=True,
    panel_no=3)
cpt_processed_plot.set_xaxis(title=r'$ q_c \ \text{[MPa]} $', panel_no=1)
cpt_processed_plot.set_xaxis(title=r'$ I_c \ \text{[-]} $', panel_no=2, range=(1, 3.5))
cpt_processed_plot.set_xaxis(title=r'$ G_{max} \ \text{[kPa]} $', panel_no=3, range=(0, 200e3))
cpt_processed_plot.set_zaxis(title=r'$ z \ \text{[m]} $', range=(20, 0))
cpt_processed_plot.show()